
/**
 * This ruleset enforces a strict user-ownership model for a farm management application.
 *
 * Core Philosophy:
 * The security model is built on the principle that users own and have exclusive
 * control over their data. All data, including farms, gate valves, and motors,
 * is private and can only be accessed by the authenticated user who created it.
 * There is no concept of public data or shared access in this ruleset.
 *
 * Data Structure:
 * All data is hierarchically nested under a user-specific path: `/users/{userId}`.
 * This structure makes ownership clear and allows for efficient, path-based security.
 *
 * Key Security Decisions:
 * - User Enumeration Blocked: Listing the top-level `/users` collection is explicitly
 *   disallowed to prevent malicious actors from discovering all user profiles.
 * - Strict Path-Based Ownership: All rules rely on comparing the authenticated
 *   user's UID (`request.auth.uid`) with the `{userId}` wildcard in the document path.
 * - No Cross-User Access: There are no rules that permit one user to view or
 *   modify another user's data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // -------------------------------------------------------------------------
    // Collection Rules
    // -------------------------------------------------------------------------

    // User can only read/write documents under their own user ID.
    match /users/{userId}/{document=**} {
      allow read, write: if isOwner(userId);
    }
    
    // Explicitly handle the top-level user profile document to prevent list operations.
    match /users/{userId} {
       allow get, create, update, delete: if isOwner(userId);
       // Disallow listing all users.
       allow list: if false;
    }
  }
}
