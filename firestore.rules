
/**
 * This ruleset enforces a strict user-ownership model for a farm management application.
 *
 * Core Philosophy:
 * The security model is built on the principle that users own and have exclusive
 * control over their data. All data, including farms, gate valves, and motors,
 * is private and can only be accessed by the authenticated user who created it.
 * There is no concept of public data or shared access in this ruleset.
 *
 * Data Structure:
 * All data is hierarchically nested under a user-specific path: `/users/{userId}`.
 * A user's profile is at `/users/{userId}`. Their farms are in a subcollection
 * at `/users/{userId}/farms/{farmId}`, and devices for that farm are further nested.
 * This structure makes ownership clear and allows for efficient, path-based security.
 *
 * Key Security Decisions:
 * - User Enumeration Blocked: Listing the top-level `/users` collection is explicitly
 *   disallowed to prevent malicious actors from discovering all user profiles.
 * - Strict Path-Based Ownership: All rules rely on comparing the authenticated
 *   user's UID (`request.auth.uid`) with the `{userId}` wildcard in the document path.
 * - No Cross-User Access: There are no rules that permit one user to view or
 *   modify another user's data.
 * - Relational Integrity: On document creation, rules validate that internal ID
 *   fields (e.g., `ownerId`, `farmId`) match the IDs in the document path, ensuring
 *   data consistency. These fields are enforced as immutable on update.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isValidNewUser(userId) {
      let hasNoExtraFields = !('lastWeatherLocation' in request.resource.data) && !('farmDetails' in request.resource.data);
      return request.resource.data.id == userId && hasNoExtraFields;
    }

    function hasImmutableUserFields() {
      let allowedKeys = ['id', 'email', 'firstName', 'lastName', 'lastWeatherLocation', 'farmDetails'];
      let incomingKeys = request.resource.data.keys();
      
      return request.resource.data.id == resource.data.id
        && request.resource.data.email == resource.data.email
        && request.resource.data.firstName == resource.data.firstName
        && request.resource.data.lastName == resource.data.lastName
        && incomingKeys.hasAll(allowedKeys) && allowedKeys.hasAll(incomingKeys);
    }

    function isValidNewFarm(userId, farmId) {
      let data = request.resource.data;
      return data.ownerId == userId && data.id == farmId;
    }

    function hasImmutableFarmFields() {
      let incomingData = request.resource.data;
      let existingData = resource.data;
      // Allow updates to all fields except ownerId and id.
      return incomingData.ownerId == existingData.ownerId
          && incomingData.id == existingData.id;
    }

    function isValidNewGateValve(farmId, gateValveId) {
      let data = request.resource.data;
      return data.farmId == farmId
          && data.id == gateValveId;
    }

    function hasImmutableGateValveFields() {
      let data = request.resource.data;
      return data.farmId == resource.data.farmId
          && data.id == resource.data.id;
    }

    function isValidNewMotor(farmId, motorId) {
      let data = request.resource.data;
      return data.farmId == farmId && data.id == motorId;
    }

    function hasImmutableMotorFields() {
      let data = request.resource.data;
      return data.farmId == resource.data.farmId && data.id == resource.data.id;
    }


    // -------------------------------------------------------------------------
    // Collection Rules
    // -------------------------------------------------------------------------

    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && isValidNewUser(userId);
      allow update: if isOwner(userId) && hasImmutableUserFields();
      allow delete: if isOwner(userId);

      match /farms/{farmId} {
        allow get, list, delete: if isOwner(userId);
        allow create: if isOwner(userId) && isValidNewFarm(userId, farmId);
        allow update: if isOwner(userId) && hasImmutableFarmFields();
        
        match /gateValves/{gateValveId} {
          allow get, list, delete: if isOwner(userId);
          allow create: if isOwner(userId) && isValidNewGateValve(farmId, gateValveId);
          allow update: if isOwner(userId) && hasImmutableGateValveFields();
        }

        match /motors/{motorId} {
          allow get, list, delete: if isOwner(userId);
          allow create: if isOwner(userId) && isValidNewMotor(farmId, motorId);
          allow update: if isOwner(userId) && hasImmutableMotorFields();
        }
      }
    }
  }
}

    